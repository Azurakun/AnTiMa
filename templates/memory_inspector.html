<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Memory Inspector | AnTiMa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        discord: '#5865F2', 
                        darkbg: '#202225', 
                        card: '#2f3136', 
                        hover: '#36393f', 
                        sidebar: '#18191c',
                        terminal: '#0c0c0c'
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', '"Courier New"', 'Courier', 'monospace']
                    }
                } 
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1b1e; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .blink { animation: blinker 1s step-end infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* Status Colors */
        .status-alive { color: #4ade80; border-color: #4ade80; background-color: rgba(74, 222, 128, 0.1); }
        .status-dead { color: #f87171; border-color: #f87171; background-color: rgba(248, 113, 113, 0.1); }
        
        /* Terminal Specifics */
        .terminal-text { font-family: 'Fira Code', monospace; }
        .log-entry:hover { background-color: rgba(255, 255, 255, 0.05); }
    </style>
</head>
<body class="bg-darkbg text-gray-100 font-sans h-screen flex flex-col overflow-hidden selection:bg-discord selection:text-white">

    <nav class="bg-card border-b border-gray-700 p-4 shrink-0 shadow-md z-20 flex justify-between items-center px-6">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 rounded bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-lg shadow-lg">üß†</div>
            <h1 class="text-xl font-bold tracking-wide text-white">Neural Memory Inspector</h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="connection-status" class="text-xs font-mono text-gray-500 bg-black/30 px-3 py-1 rounded-full border border-gray-700 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-gray-500 animate-pulse"></span> Connecting...
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-64 bg-sidebar border-r border-gray-700 flex flex-col shrink-0 transition-all">
            <div class="p-6 border-b border-gray-800">
                <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Memory Banks</h2>
                <nav class="space-y-1">
                    <button onclick="switchTab('overview')" id="nav-overview" class="nav-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 bg-discord text-white text-sm font-bold shadow-md transition-all">
                        <span>üìä</span> Overview
                    </button>
                    <button onclick="switchTab('quests')" id="nav-quests" class="nav-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-400 hover:bg-gray-800 hover:text-gray-200 text-sm font-bold transition-all">
                        <span>üõ°Ô∏è</span> Quests
                    </button>
                    <button onclick="switchTab('events')" id="nav-events" class="nav-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-400 hover:bg-gray-800 hover:text-gray-200 text-sm font-bold transition-all">
                        <span>üìÖ</span> Events
                    </button>
                    <button onclick="switchTab('npcs')" id="nav-npcs" class="nav-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-400 hover:bg-gray-800 hover:text-gray-200 text-sm font-bold transition-all">
                        <span>üë•</span> NPC Registry
                    </button>
                    <button onclick="switchTab('locations')" id="nav-locations" class="nav-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-400 hover:bg-gray-800 hover:text-gray-200 text-sm font-bold transition-all">
                        <span>üìç</span> Locations
                    </button>
                    <div class="my-2 border-t border-gray-800"></div>
                    <button onclick="switchTab('logs')" id="nav-logs" class="nav-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-green-400 hover:bg-green-900/20 text-sm font-mono font-bold border border-transparent hover:border-green-800 transition-all">
                        <span>>_</span> DM Terminal
                    </button>
                </nav>
            </div>
            
            <div class="mt-auto p-6 space-y-4">
                 <a id="export-btn" href="#" target="_blank" class="w-full text-center block px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold text-sm border border-gray-600 transition shadow-lg">
                    üíæ Export Story
                 </a>

                 <div class="bg-black/40 p-4 rounded-xl border border-gray-800 backdrop-blur-sm">
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3">Live Session Metadata</h3>
                    <div id="sidebar-meta" class="text-xs space-y-2 text-gray-400 font-mono">
                        <div class="animate-pulse">Loading stream...</div>
                    </div>
                 </div>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-darkbg p-8 custom-scrollbar relative">
            
            <div id="view-overview" class="tab-view fade-in space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight" id="meta-title">Loading...</h2>
                        <div class="text-sm text-gray-400 mt-1 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span> Live Neural Link Active
                        </div>
                    </div>
                    <span class="px-4 py-1.5 bg-green-500/10 text-green-400 border border-green-500/30 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm">Active Session</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-card p-6 rounded-2xl border border-gray-700 shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl group-hover:scale-110 transition-transform">üìú</div>
                        <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Total Turns</div>
                        <div class="text-4xl font-bold text-white mt-2" id="stat-turns">-</div>
                    </div>
                    <div class="bg-card p-6 rounded-2xl border border-gray-700 shadow-lg relative overflow-hidden group">
                         <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl group-hover:scale-110 transition-transform">üë•</div>
                         <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">NPCs Met</div>
                         <div class="text-4xl font-bold text-blue-400 mt-2" id="stat-npcs">-</div>
                    </div>
                     <div class="bg-card p-6 rounded-2xl border border-gray-700 shadow-lg relative overflow-hidden group">
                         <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl group-hover:scale-110 transition-transform">üõ°Ô∏è</div>
                         <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Active Quests</div>
                         <div class="text-4xl font-bold text-orange-400 mt-2" id="stat-quests">-</div>
                    </div>
                     <div class="bg-card p-6 rounded-2xl border border-gray-700 shadow-lg relative overflow-hidden group">
                         <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl group-hover:scale-110 transition-transform">üìç</div>
                         <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Locations</div>
                         <div class="text-4xl font-bold text-emerald-400 mt-2" id="stat-locs">-</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-card rounded-2xl border border-gray-700 overflow-hidden shadow-md">
                        <div class="bg-gray-800/50 px-6 py-4 border-b border-gray-700"><h3 class="font-bold text-gray-200 flex items-center gap-2">üé≠ Adventuring Party</h3></div>
                        <div id="overview-party" class="p-6 space-y-3"></div>
                    </div>
                    <div class="bg-card rounded-2xl border border-gray-700 overflow-hidden shadow-md">
                        <div class="bg-gray-800/50 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                            <h3 class="font-bold text-orange-400 flex items-center gap-2">üõ°Ô∏è Current Objectives</h3>
                            <button onclick="switchTab('quests')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white transition">View All</button>
                        </div>
                        <div id="overview-quests" class="p-6 space-y-3"></div>
                    </div>
                </div>
            </div>

            <div id="view-quests" class="tab-view hidden fade-in max-w-6xl mx-auto space-y-8">
                <div>
                    <h2 class="text-2xl font-bold text-orange-400 mb-4 flex items-center gap-3">
                        <span class="bg-orange-500/10 p-2 rounded-lg border border-orange-500/20 text-xl">üõ°Ô∏è</span> Active Objectives
                    </h2>
                    <div id="container-quests-active" class="grid gap-4"></div>
                </div>
                <div class="opacity-70 hover:opacity-100 transition-opacity">
                    <h2 class="text-xl font-bold text-green-400 mb-4 flex items-center gap-3">
                        <span class="bg-green-500/10 p-2 rounded-lg border border-green-500/20 text-lg">‚úÖ</span> Completed Log
                    </h2>
                    <div id="container-quests-completed" class="grid gap-4"></div>
                </div>
            </div>

            <div id="view-events" class="tab-view hidden fade-in max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6 flex items-center gap-3">
                    <span class="bg-yellow-500/10 p-2 rounded-lg border border-yellow-500/20">üìÖ</span> Event Timeline
                </h2>
                <div id="container-events" class="space-y-4 relative border-l-2 border-gray-700 ml-4 pl-8"></div>
            </div>

            <div id="view-npcs" class="tab-view hidden fade-in max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-blue-400 flex items-center gap-3">
                         <span class="bg-blue-500/10 p-2 rounded-lg border border-blue-500/20">üë•</span> NPC Registry
                    </h2>
                    <button onclick="openEditNPCModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition">
                        + Add NPC
                    </button>
                </div>
                <div id="container-npcs" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </div>

            <div id="view-locations" class="tab-view hidden fade-in max-w-6xl mx-auto">
                <h2 class="text-2xl font-bold text-emerald-400 mb-6 flex items-center gap-3">
                    <span class="bg-emerald-500/10 p-2 rounded-lg border border-emerald-500/20">üìç</span> World Map
                </h2>
                <div id="container-locations" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>

            <div id="view-logs" class="tab-view hidden fade-in h-full flex flex-col gap-4">
                
                <div class="flex justify-between items-end pb-2 border-b border-gray-800">
                    <div>
                        <h2 class="text-2xl font-bold text-green-500 font-mono tracking-tighter flex items-center gap-2">
                            <span class="animate-pulse">>_</span> SYSTEM_DEBUG_TERMINAL
                        </h2>
                        <div class="text-[10px] text-gray-500 font-mono uppercase tracking-widest mt-1">
                            AnTiMa Core v2.5 // Live Neural Stream
                        </div>
                    </div>
                    <div class="flex gap-2 text-xs font-mono">
                        <div class="px-2 py-1 bg-gray-800 rounded text-gray-400">STATUS: <span class="text-green-400">ONLINE</span></div>
                        <div class="px-2 py-1 bg-gray-800 rounded text-gray-400" id="terminal-clock">00:00:00</div>
                    </div>
                </div>
                
                <div class="flex flex-1 gap-4 overflow-hidden min-h-0">
                    
                    <div class="flex-1 bg-terminal rounded-lg border border-gray-800 p-4 font-mono text-xs text-gray-300 overflow-y-auto custom-scrollbar shadow-inner flex flex-col" id="terminal-container">
                        <div class="mb-4 text-gray-600 select-none">
                            // Initializing connection to neural backend...<br>
                            // Authenticated. Streaming logs...
                        </div>
                        <div id="terminal-output" class="space-y-0.5 flex-1"></div>
                        <div class="mt-2 text-green-500 font-bold flex items-center gap-1">
                            <span>$</span> <span class="blink w-2 h-4 bg-green-500 block"></span>
                        </div>
                    </div>

                    <div class="w-1/3 bg-gray-900 rounded-lg border border-gray-700 flex flex-col shadow-lg">
                         <div class="bg-gray-800 px-4 py-2 border-b border-gray-700 flex justify-between items-center">
                             <h3 class="text-xs font-bold uppercase text-gray-300 font-mono">Data Packet Inspector</h3>
                             <span class="text-[10px] text-gray-500">JSON</span>
                         </div>
                         <div class="p-4 overflow-y-auto text-xs font-mono text-blue-300 custom-scrollbar flex-1 whitespace-pre-wrap select-text" id="json-viewer">
// Select a log entry from the terminal to inspect attached data payloads.
                         </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="quest-modal" class="fixed inset-0 bg-black/80 hidden z-[100] flex justify-center items-center backdrop-blur-sm p-4 fade-in" onclick="closeModal('quest-modal')">
        <div class="bg-card w-full max-w-2xl rounded-2xl shadow-2xl border border-gray-700 flex flex-col overflow-hidden transform transition-all scale-100" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-700 bg-gray-800 flex justify-between items-center">
                <div>
                    <h2 id="modal-quest-name" class="text-2xl font-bold text-orange-400">Quest Name</h2>
                    <div id="modal-quest-status" class="text-xs font-bold uppercase tracking-wider mt-1">ACTIVE</div>
                </div>
                <button onclick="closeModal('quest-modal')" class="bg-gray-700 hover:bg-gray-600 rounded-full p-2 transition text-gray-300 hover:text-white">‚úï</button>
            </div>
            <div class="p-8 space-y-6 bg-darkbg">
                <div><h3 class="text-gray-500 font-bold uppercase text-[10px] mb-2">Description</h3><p id="modal-quest-desc" class="text-gray-300 leading-relaxed text-sm"></p></div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-card p-3 rounded border border-gray-700"><h3 class="text-blue-400 font-bold uppercase text-[10px] mb-1">Issuer</h3><div id="modal-quest-issuer" class="text-white text-sm"></div></div>
                    <div class="bg-card p-3 rounded border border-gray-700"><h3 class="text-green-400 font-bold uppercase text-[10px] mb-1">Completion Condition</h3><div id="modal-quest-trigger" class="text-white text-sm font-mono text-xs"></div></div>
                </div>
                <div><h3 class="text-yellow-500 font-bold uppercase text-[10px] mb-2">Rewards</h3><div id="modal-quest-rewards" class="text-yellow-100/80 italic text-sm"></div></div>
            </div>
        </div>
    </div>

    <div id="npc-modal" class="fixed inset-0 bg-black/80 hidden z-[100] flex justify-center items-center backdrop-blur-sm p-4 fade-in" onclick="closeModal('npc-modal')">
        <div class="bg-card w-full max-w-3xl rounded-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-700 bg-gray-800 flex justify-between items-center">
                <div>
                    <h2 id="modal-npc-name" class="text-3xl font-bold text-white">NPC Name</h2>
                    <div id="modal-npc-role" class="text-gray-500 text-xs font-bold uppercase tracking-wider mt-1">Role / Class</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openEditNPCModal(true)" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded text-xs font-bold">Edit</button>
                    <button onclick="deleteNPC()" class="bg-red-900/50 hover:bg-red-700 text-red-200 px-3 py-1 rounded text-xs font-bold border border-red-800">Delete</button>
                    <button onclick="closeModal('npc-modal')" class="bg-gray-700 hover:bg-gray-600 rounded-full p-2 transition text-gray-300 hover:text-white ml-2">‚úï</button>
                </div>
            </div>
            
            <div class="p-8 overflow-y-auto custom-scrollbar flex-1 space-y-6 bg-darkbg">
                <div id="modal-npc-aliases-container" class="hidden">
                    <h3 class="text-indigo-400 font-bold uppercase text-[10px] mb-2">Known Aliases</h3>
                    <div id="modal-npc-aliases" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="bg-card p-3 rounded border border-gray-700"><div class="text-[10px] uppercase text-gray-500 font-bold">Age</div><div id="modal-npc-age" class="text-white font-bold">-</div></div>
                    <div class="bg-card p-3 rounded border border-gray-700"><div class="text-[10px] uppercase text-gray-500 font-bold">Gender</div><div id="modal-npc-gender" class="text-white font-bold">-</div></div>
                    <div class="bg-card p-3 rounded border border-gray-700"><div class="text-[10px] uppercase text-gray-500 font-bold">Race</div><div id="modal-npc-race" class="text-white font-bold">-</div></div>
                </div>

                <div class="grid grid-cols-2 gap-4 text-center">
                     <div class="bg-card p-3 rounded border border-gray-700"><div class="text-[10px] uppercase text-gray-500 font-bold">State</div><div id="modal-npc-state" class="font-bold">-</div></div>
                     <div class="bg-card p-3 rounded border border-gray-700"><div class="text-[10px] uppercase text-gray-500 font-bold">Condition</div><div id="modal-npc-condition" class="font-bold text-white">-</div></div>
                </div>

                <div class="space-y-4">
                    <div><h3 class="text-blue-400 font-bold uppercase text-[10px] border-b border-gray-700 pb-1 mb-2">Appearance</h3><p id="modal-npc-app" class="text-gray-300 text-sm leading-relaxed"></p></div>
                    <div><h3 class="text-purple-400 font-bold uppercase text-[10px] border-b border-gray-700 pb-1 mb-2">Personality</h3><p id="modal-npc-personality" class="text-gray-300 text-sm leading-relaxed"></p></div>
                    <div class="bg-blue-900/10 p-4 rounded border border-blue-900/30"><h3 class="text-blue-300 font-bold uppercase text-[10px] mb-1">Relationships</h3><p id="modal-npc-rel" class="text-blue-100/80 text-sm italic"></p></div>
                    <div><h3 class="text-gray-400 font-bold uppercase text-[10px] border-b border-gray-700 pb-1 mb-2">Biography</h3><p id="modal-npc-backstory" class="text-gray-400 text-sm leading-relaxed"></p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="npc-form-modal" class="fixed inset-0 bg-black/90 hidden z-[110] flex justify-center items-center backdrop-blur-sm p-4 fade-in" onclick="closeModal('npc-form-modal')">
        <div class="bg-sidebar w-full max-w-xl rounded-2xl shadow-2xl border border-gray-600 flex flex-col max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-700 bg-gray-800 flex justify-between items-center">
                <h2 id="npc-form-title" class="text-xl font-bold text-white">Add New NPC</h2>
                <button onclick="closeModal('npc-form-modal')" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-4">
                <input type="hidden" id="edit-original-name">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Name</label>
                    <input id="in-name" type="text" class="w-full bg-darkbg border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Race</label><input id="in-race" type="text" class="w-full bg-darkbg border border-gray-700 rounded p-2 text-white text-sm"></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Gender</label><input id="in-gender" type="text" class="w-full bg-darkbg border border-gray-700 rounded p-2 text-white text-sm"></div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Summary (Details)</label>
                    <textarea id="in-details" class="w-full bg-darkbg border border-gray-700 rounded p-2 text-white text-sm h-20"></textarea>
                </div>
                <div>
                     <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Appearance</label>
                     <textarea id="in-app" class="w-full bg-darkbg border border-gray-700 rounded p-2 text-white text-sm h-16"></textarea>
                </div>
                <div>
                     <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Personality</label>
                     <textarea id="in-pers" class="w-full bg-darkbg border border-gray-700 rounded p-2 text-white text-sm h-16"></textarea>
                </div>
                <button onclick="submitNPCForm()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded font-bold shadow-lg transition mt-4">Save Entity</button>
            </div>
        </div>
    </div>

    <script>
        const threadId = "{{ thread_id }}";
        
        // --- CORE NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.id === 'nav-logs') {
                    el.className = "nav-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-green-400 hover:bg-green-900/20 text-sm font-mono font-bold border border-transparent hover:border-green-800 transition-all";
                } else {
                    el.className = "nav-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-400 hover:bg-gray-800 hover:text-gray-200 text-sm font-bold transition-all";
                }
            });

            const btn = document.getElementById(`nav-${tabId}`);
            if(tabId === 'logs') {
                 btn.className = "nav-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 bg-green-900/30 text-green-400 border border-green-600/50 text-sm font-mono font-bold shadow-md transition-all";
            } else {
                 btn.className = "nav-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 bg-discord text-white text-sm font-bold shadow-md transition-all";
            }
            document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- DATA CONTAINERS ---
        let npcDatabase = {};
        let questDatabase = {};

        // --- TERMINAL LOGIC ---
        function renderTerminalLine(log) {
            const div = document.createElement('div');
            let levelColor = "text-gray-500";
            let msgColor = "text-gray-300";
            let prefix = "INFO";
            if (log.level === 'warn') { levelColor = "text-yellow-500"; msgColor = "text-yellow-100"; prefix = "WARN"; }
            if (log.level === 'error') { levelColor = "text-red-500 font-bold"; msgColor = "text-red-300"; prefix = "ERR "; }
            if (log.level === 'system') { levelColor = "text-blue-400"; msgColor = "text-blue-200"; prefix = "SYS "; }
            if (log.level === 'ai') { levelColor = "text-purple-400 font-bold"; msgColor = "text-purple-200"; prefix = "AI  "; }

            div.className = `log-entry flex gap-3 px-2 py-0.5 cursor-pointer rounded transition-colors border-l-2 border-transparent hover:border-gray-600`;
            div.innerHTML = `
                <span class="text-gray-600 shrink-0 font-mono">[${log.time}]</span>
                <span class="${levelColor} shrink-0 font-mono font-bold">${prefix}</span>
                <span class="${msgColor} font-mono truncate">${log.message}</span>
            `;
            div.onclick = () => {
                document.getElementById('json-viewer').innerText = JSON.stringify(log.details || {}, null, 2);
                document.querySelectorAll('.log-entry').forEach(e => e.classList.remove('bg-white/5', 'border-gray-500'));
                div.classList.add('bg-white/5', 'border-gray-500');
            };
            return div;
        }

        async function updateTerminal() {
            try {
                const res = await fetch(`/api/rpg/debug/${threadId}`);
                if(!res.ok) return;
                const logs = await res.json();
                const container = document.getElementById('terminal-output');
                container.innerHTML = ""; 
                logs.forEach(log => container.appendChild(renderTerminalLine(log)));
            } catch (e) { console.error(e); }
            document.getElementById('terminal-clock').innerText = new Date().toLocaleTimeString('en-US', {hour12: false});
        }

        // --- MAIN DATA SYNC ---
        async function loadData() {
            try {
                const res = await fetch(`/api/rpg/memory/${threadId}`);
                const data = await res.json();
                if (data.error) {
                    document.getElementById('connection-status').innerHTML = `<span class="text-red-400">Disconnected</span>`;
                    return;
                }
                document.getElementById('connection-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> <span class="text-green-400">Online</span>`;
                document.getElementById('export-btn').href = `/api/rpg/export/${threadId}`;
                document.getElementById('meta-title').innerText = data.meta.title || "Untitled Adventure";
                document.getElementById('stat-turns').innerText = data.meta.turn_count;
                document.getElementById('stat-npcs').innerText = data.npcs.length;
                document.getElementById('stat-quests').innerText = data.quests.filter(q => q.status === 'active').length;
                document.getElementById('stat-locs').innerText = data.locations.length;
                
                const env = data.environment || {};
                document.getElementById('sidebar-meta').innerHTML = `
                    <div class="flex justify-between"><span>Host</span> <span class="text-white">${data.meta.owner}</span></div>
                    <div class="flex justify-between"><span>Scenario</span> <span class="text-white truncate w-24 text-right">${data.meta.scenario}</span></div>
                    <div class="border-t border-gray-700 my-2"></div>
                    <div class="flex justify-between text-yellow-500 font-bold"><span>Story Time</span> <span>${env.time || 'Day'}</span></div>
                    <div class="flex justify-between text-blue-400"><span>Weather</span> <span>${env.weather || 'Clear'}</span></div>
                `;

                document.getElementById('overview-party').innerHTML = Object.values(data.players).map(p => `
                    <div class="flex items-center justify-between bg-black/30 p-3 rounded-lg border border-gray-700">
                        <div class="flex items-center gap-3">
                             <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center font-bold text-white shadow-md">${p.name.substring(0,2).toUpperCase()}</div>
                             <div>
                                 <div class="font-bold text-sm text-white">${p.name}</div>
                                 <div class="text-[10px] text-gray-500 uppercase tracking-wide">${p.class}</div>
                             </div>
                        </div>
                        <div class="text-right text-xs space-y-1">
                             <div class="text-green-400 bg-green-900/20 px-2 py-0.5 rounded">HP ${p.hp}/${p.max_hp}</div>
                             <div class="text-blue-400 bg-blue-900/20 px-2 py-0.5 rounded">MP ${p.mp}/${p.max_mp}</div>
                        </div>
                    </div>
                `).join('');

                const topQuests = data.quests.filter(q => q.status === 'active').slice(0, 3);
                document.getElementById('overview-quests').innerHTML = topQuests.map(q => `
                    <div class="group flex items-center gap-3 cursor-pointer hover:bg-white/5 p-2 rounded-lg transition" onclick="switchTab('quests')">
                        <div class="w-1 h-8 bg-orange-500 rounded-full group-hover:h-10 transition-all"></div>
                        <div class="overflow-hidden">
                            <div class="text-sm font-bold text-gray-200 truncate group-hover:text-orange-400">${q.name}</div>
                            <div class="text-xs text-gray-500 truncate">${q.details}</div>
                        </div>
                    </div>
                `).join('') || '<div class="text-gray-600 text-sm italic py-2">No active quests.</div>';

                data.quests.forEach(q => questDatabase[q.name] = q);
                renderQuestList('container-quests-active', data.quests.filter(q => q.status === 'active'), 'orange');
                renderQuestList('container-quests-completed', data.quests.filter(q => q.status !== 'active'), 'green');
                
                data.npcs.forEach(n => npcDatabase[n.name] = n);
                renderNPCGrid('container-npcs', data.npcs, 'blue');
                
                renderGrid('container-locations', data.locations, 'emerald');
                renderEventList('container-events', data.events);

            } catch (e) { console.error(e); }
        }

        // --- RENDERERS ---
        function renderQuestList(id, items, color) {
            const el = document.getElementById(id);
            if (!items.length) { el.innerHTML = `<div class="p-6 text-center border-2 border-dashed border-gray-800 rounded-xl text-gray-600 text-sm">Nothing to report.</div>`; return; }
            el.innerHTML = items.map(item => `
                <div onclick="openQuestModal('${item.name}')" class="bg-card p-5 rounded-xl border border-gray-700 hover:border-${color}-500/50 transition cursor-pointer group shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-100 text-lg group-hover:text-${color}-400 transition">${item.name}</h4>
                        <span class="text-xs font-mono text-gray-600">${item.last_updated ? item.last_updated.split('T')[0] : ''}</span>
                    </div>
                    <div class="text-gray-400 text-sm line-clamp-2">${item.details}</div>
                </div>
            `).join('');
        }
        function renderEventList(id, items) {
             const el = document.getElementById(id);
             if (!items.length) { el.innerHTML = `<div class="p-6 text-center text-gray-600 text-sm italic">Timeline empty.</div>`; return; }
             el.innerHTML = items.map(item => `
                <div class="relative pl-6 pb-6 border-l-2 border-gray-700 last:border-0 last:pb-0">
                    <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-gray-800 border-2 border-yellow-500"></div>
                    <div class="bg-card p-4 rounded-lg border border-gray-700 shadow-sm">
                        <h4 class="font-bold text-yellow-400 text-sm mb-1">${item.name}</h4>
                        <p class="text-gray-400 text-xs leading-relaxed">${item.details}</p>
                    </div>
                </div>
             `).join('');
        }
        function renderNPCGrid(id, items, color) {
            const el = document.getElementById(id);
            if (!items.length) { el.innerHTML = `<div class="col-span-full p-8 text-center border-2 border-dashed border-gray-800 rounded-xl text-gray-600">No data found.</div>`; return; }
            el.innerHTML = items.map(item => {
                const state = item.attributes?.state || "Alive";
                const stateColor = state.toLowerCase() === 'dead' ? 'text-red-500' : 'text-green-400';
                return `
                <div onclick="openNPCModal('${item.name}')" class="bg-card p-5 rounded-xl border border-gray-700 hover:-translate-y-1 hover:shadow-xl hover:border-${color}-500/50 transition cursor-pointer relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-${color}-500/5 rounded-full blur-xl group-hover:bg-${color}-500/10 transition"></div>
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-white text-lg truncate pr-2">${item.name}</h4>
                        <span class="text-[10px] uppercase font-bold bg-black/40 px-2 py-0.5 rounded border border-gray-700/50 ${stateColor}">${state}</span>
                    </div>
                    <div class="text-${color}-300 text-xs mb-3 italic truncate">${item.attributes?.race || 'Unknown'} | ${item.attributes?.role || 'Character'}</div>
                    <div class="text-gray-400 text-sm line-clamp-2">${item.details}</div>
                    <div class="mt-4 pt-3 border-t border-gray-700/50 flex justify-between items-center opacity-50 group-hover:opacity-100 transition">
                        <span class="text-[10px] font-bold text-${color}-400 uppercase tracking-wider">Inspect Profile</span>
                        <span>‚Üí</span>
                    </div>
                </div>
            `}).join('');
        }
        function renderGrid(id, items, color) {
             const el = document.getElementById(id);
             if (!items.length) { el.innerHTML = `<div class="col-span-full p-8 text-center border-2 border-dashed border-gray-800 rounded-xl text-gray-600">No data.</div>`; return; }
             el.innerHTML = items.map(item => `
                <div class="bg-card p-5 rounded-xl border border-gray-700 hover:border-${color}-500/50 transition">
                    <h4 class="font-bold text-white text-lg mb-2 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-${color}-500"></span> ${item.name}</h4>
                    <p class="text-gray-400 text-sm h-20 overflow-y-auto custom-scrollbar">${item.details}</p>
                </div>
             `).join('');
        }

        // --- NPC MANAGEMENT ---
        function openEditNPCModal(isEdit=false) {
            document.getElementById('npc-modal').classList.add('hidden');
            document.getElementById('npc-form-modal').classList.remove('hidden');
            
            if(isEdit) {
                const name = document.getElementById('modal-npc-name').innerText;
                const npc = npcDatabase[name];
                document.getElementById('npc-form-title').innerText = "Edit NPC: " + name;
                document.getElementById('edit-original-name').value = name;
                document.getElementById('in-name').value = npc.name;
                document.getElementById('in-race').value = npc.attributes.race || "";
                document.getElementById('in-gender').value = npc.attributes.gender || "";
                document.getElementById('in-details').value = npc.details || "";
                document.getElementById('in-app').value = npc.attributes.appearance || "";
                document.getElementById('in-pers').value = npc.attributes.personality || "";
            } else {
                document.getElementById('npc-form-title').innerText = "Add New NPC";
                document.getElementById('edit-original-name').value = "";
                // Clear fields
                ['in-name','in-race','in-gender','in-details','in-app','in-pers'].forEach(id => document.getElementById(id).value = "");
            }
        }

        async function submitNPCForm() {
            const originalName = document.getElementById('edit-original-name').value;
            const action = originalName ? 'edit' : 'add';
            
            const payload = {
                thread_id: threadId,
                action: action,
                original_name: originalName || null,
                data: {
                    name: document.getElementById('in-name').value,
                    details: document.getElementById('in-details').value,
                    status: "active",
                    attributes: {
                        race: document.getElementById('in-race').value,
                        gender: document.getElementById('in-gender').value,
                        appearance: document.getElementById('in-app').value,
                        personality: document.getElementById('in-pers').value
                    }
                }
            };

            await fetch('/api/rpg/manage/npc', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            closeModal('npc-form-modal');
            loadData();
        }

        async function deleteNPC() {
            const name = document.getElementById('modal-npc-name').innerText;
            if(!confirm(`Delete ${name} permanently?`)) return;
            
            await fetch('/api/rpg/manage/npc', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({thread_id: threadId, action: 'delete', original_name: name})
            });
            closeModal('npc-modal');
            loadData();
        }

        // --- DETAILS POPULATION ---
        function openQuestModal(name) {
            const q = questDatabase[name];
            if(!q) return;
            const attrs = q.attributes || {};
            document.getElementById('modal-quest-name').innerText = q.name;
            document.getElementById('modal-quest-desc').innerText = q.details;
            document.getElementById('modal-quest-status').innerText = q.status;
            document.getElementById('modal-quest-status').className = q.status === 'active' ? "text-xs font-bold uppercase tracking-wider mt-1 text-green-400" : "text-xs font-bold uppercase tracking-wider mt-1 text-gray-500";
            document.getElementById('modal-quest-issuer').innerText = attrs.issuer || "Unknown";
            // [UPDATED] Show Trigger
            document.getElementById('modal-quest-trigger').innerText = attrs.completion_condition || attrs.trigger || "Check Quest Log";
            document.getElementById('modal-quest-rewards').innerText = attrs.rewards || "None";
            document.getElementById('quest-modal').classList.remove('hidden');
        }

        function openNPCModal(name) {
            const n = npcDatabase[name];
            if(!n) return;
            const attrs = n.attributes || {};
            document.getElementById('modal-npc-name').innerText = n.name;
            document.getElementById('modal-npc-role').innerText = attrs.role || "Character";
            document.getElementById('modal-npc-age').innerText = attrs.age || "?";
            document.getElementById('modal-npc-gender').innerText = attrs.gender || "?";
            document.getElementById('modal-npc-race').innerText = attrs.race || "?";
            const stateEl = document.getElementById('modal-npc-state');
            stateEl.innerText = attrs.state || "Alive";
            stateEl.className = attrs.state?.toLowerCase() === 'dead' ? "font-bold text-red-500" : "font-bold text-green-400";
            document.getElementById('modal-npc-condition').innerText = attrs.condition || "Healthy";
            document.getElementById('modal-npc-app').innerText = attrs.appearance || "No description.";
            document.getElementById('modal-npc-personality').innerText = attrs.personality || "No personality data.";
            document.getElementById('modal-npc-rel').innerText = attrs.relationships || attrs.relationship || "Neutral";
            document.getElementById('modal-npc-backstory').innerText = attrs.bio || attrs.backstory || "No history.";
            
            const aliasCont = document.getElementById('modal-npc-aliases-container');
            const aliasList = document.getElementById('modal-npc-aliases');
            aliasList.innerHTML = "";
            if(attrs.aliases && attrs.aliases.length) {
                aliasCont.classList.remove('hidden');
                attrs.aliases.forEach(a => {
                    aliasList.innerHTML += `<span class="bg-indigo-900/50 text-indigo-300 px-2 py-0.5 rounded text-xs border border-indigo-700/50">${a}</span>`;
                });
            } else { aliasCont.classList.add('hidden'); }
            document.getElementById('npc-modal').classList.remove('hidden');
        }

        loadData();
        updateTerminal();
        setInterval(loadData, 5000);
        setInterval(updateTerminal, 2500); 
    </script>
</body>
</html>